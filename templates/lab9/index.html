{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <link rel="stylesheet" href="{{ url_for('static', filename='lab9/lab9.css') }}">

    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏ -->
    <div class="lab9-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é -->
        <h1 class="lab9-title">–í—ã–±–∏—Ä–∞–π —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫!</h1>
        
        <!-- –°—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ -->
        <p class="lab9-counter">
            –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: 
            <span id="closed-count">{{ count }}</span>
        </p>
        
        <!-- –¶–∏–∫–ª Django —Å–æ–∑–¥–∞–µ—Ç –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
        {% for gift in gifts %}
            <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞ –ø–æ–¥–∞—Ä–∫–∞ -->
            <!-- –ö–ª–∞—Å—Å—ã: 'opened' - –µ—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞, 'auth-required' - —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
            <div class="gift-box 
                {% if gift.opened %}opened{% endif %} 
                {% if gift.auth_required and not is_authenticated %}auth-required{% endif %}" 
                id="gift-{{ gift.id }}"
                onclick="openGift({{ gift.id }})"
                style="top: {{ gift.top }}px; left: {{ gift.left }}px;">
                
                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
                <img src="{{ gift.image }}" alt="–ü–æ–¥–∞—Ä–æ–∫" class="gift-image">
            </div>
        {% endfor %}
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –ø–æ–¥–∞—Ä–∫–∞ -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <!-- –ü–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
            <h2 class="modal-header-text">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ù–æ–≤—ã–º 2026 –ì–æ–¥–æ–º!</h2>
            
            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é—Ä–ø—Ä–∏–∑–∞ –∏–∑ –ø–æ–¥–∞—Ä–∫–∞ -->
            <img id="modal-image" src="" class="modal-gift-image">
            
            <!-- –¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <p id="modal-text" class="modal-congratulation"></p>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
            <button onclick="closeModal()" class="modal-button">–°–ø–∞—Å–∏–±–æ!</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –∏–≥—Ä—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) -->
    {% if is_authenticated %}
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <div class="reset-container">
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
            <button onclick="resetGame()" class="reset-button">
                üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑
            </button>
        </div>
    {% endif %}

    <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–¥–∞—Ä–∫–∞
    function openGift(id) {
        const boxElement = document.getElementById('gift-' + id);
        
        // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if(boxElement.classList.contains('opened')) return;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–¥–∞—Ä–∫–∞
        fetch('/lab9/rest-api/gifts/' + id, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function(response) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
            if (response.ok) {
                return response.json(); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–≤–µ—Ç –≤ JSON
            } else {
                // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, —Ç–æ–∂–µ –ø–∞—Ä—Å–∏–º –µ—ë, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                return response.json().then(function(errorData) {
                    // –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ –±–ª–æ–∫ catch –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–¥–µ—Å—å
                    throw new Error(errorData.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                });
            }
        })
        .then(function(data) {
            // –£—Å–ø–µ—à–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ: –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ "–æ—Ç–∫—Ä—ã–≤–∞–µ–º" –∫–æ—Ä–æ–±–∫—É
            boxElement.classList.add('opened');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫
            let countSpan = document.getElementById('closed-count');
            let currentVal = parseInt(countSpan.innerText);
            if(currentVal > 0) {
                countSpan.innerText = currentVal - 1;
            }

            // –ù–∞–ø–æ–ª–Ω—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('modal-image').src = data.image;
            document.getElementById('modal-text').innerText = data.congratulation;
            showModal();
        })
        .catch(function(error) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            alert(error.message);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –∏–≥—Ä—ã
    function resetGame() {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–±—Ä–æ—Å
        fetch('/lab9/rest-api/gifts/reset', {
            method: 'POST'
        })
        .then(function(response) {
            if(response.ok) {
                return response.json();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ');
            }
        })
        .then(function(data) {
            // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(function(error) {
            console.error(error);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É");
        });
    }

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
    function showModal() {
        document.getElementById('myModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('myModal').style.display = 'none';
    }
    </script>
{% endblock %}